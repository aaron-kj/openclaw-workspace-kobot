# 2026-02-03 (Monday)

## GitHub Security Alert - Token Leak & Full Remediation (10:27 AM - 1:54 PM JST)

### üö® Initial Alert
**Time:** 10:27 AM JST  
**Source:** GitHub Secret Scanning  
**Finding:** Telegram bot token exposed in `memory/2026-01-30.md` (commit a093a0d3)  
**Repository:** aaron-kj/openclaw-workspace-kobot

### üîç Security Audit
Performed comprehensive scan across all workspace files:
```bash
git grep -E '[0-9]{7,}:[A-Za-z0-9_-]{30,}'  # Telegram tokens
git grep -E '(sk-|ghp_|gho_|xox)'           # API keys
grep -r "password" --include="*.md"         # Passwords
```

**Findings:**
1. ‚úÖ **Git repository:** Only 1 token found (the reported Telegram token)
2. ‚ö†Ô∏è **Local config (`~/.openclaw/openclaw.json`):** Multiple hardcoded tokens:
   - Telegram bot token (revoked)
   - Slack bot token (xoxb-...)
   - Slack app token (xapp-...)
   - Gateway auth token (local only)
3. ‚ö†Ô∏è **Shell config (`~/.zshrc`):** Anthropic API key hardcoded

### üîê Remediation Steps

#### 1. Token Rotation
- **Telegram:** Revoked old token via @BotFather, generated new token
- **Slack:** Kept existing (not exposed in git)
- **Others:** Moved to secure storage

#### 2. Centralized Secret Management
Created `~/.env` (chmod 600):
```bash
TELEGRAM_BOT_TOKEN=[REDACTED]
SLACK_BOT_TOKEN=[REDACTED]
SLACK_APP_TOKEN=[REDACTED]
ANTHROPIC_API_KEY=[REDACTED]
ANTHROPIC_BASE_URL=https://api.ai.public.rakuten-it.com/claude-code-aws-bedrock/v1
NODE_EXTRA_CA_CERTS=$HOME/netskope-ca-bundle.pem
```

#### 3. Configuration Updates

**Updated `~/.openclaw/openclaw.json`:**
- Changed hardcoded tokens to environment variable references
- Initially tried `${TELEGRAM_BOT_TOKEN}` syntax (didn't work with LaunchAgent)
- Final solution: Hardcoded in config + environment in LaunchAgent plist

**Updated `~/.zshrc`:**
- Removed hardcoded Anthropic API key
- Added automatic `~/.env` loading on shell startup:
```bash
if [ -f "$HOME/.env" ]; then
  set -a
  source "$HOME/.env"
  set +a
fi
```
- Made OpenClaw completion conditional (prevents errors if not installed)

**Updated LaunchAgent (`~/Library/LaunchAgents/com.clawdbot.gateway.plist`):**
- Added all tokens to `<key>EnvironmentVariables</key>` section
- This was the KEY fix - SIGUSR1 restarts don't reload env vars
- Required full `launchctl unload/load` cycle to apply

#### 4. Git Cleanup

**Created `.gitignore`:**
```
# Environment variables
.env
*.env
.env.*

# Clawdbot config (may contain secrets)
config.yaml
config.yml
gateway.yaml
gateway.yml

# Session data, logs, OS files, etc.
```

**Redacted exposed token:**
- Edited `memory/2026-01-30.md`: Replaced token with `[REDACTED - revoked 2026-02-03]`
- Committed changes with security-focused message
- Pushed to GitHub

**Git history:** Did NOT rewrite (token already revoked, low risk)

### üêõ Troubleshooting Journey

**Issue:** Multiple restart attempts failed with `401 Unauthorized`

**Attempts:**
1. ‚ùå Updated config, sent SIGUSR1 restart signal ‚Üí Config not reloaded
2. ‚ùå Killed gateway process manually ‚Üí Started without environment
3. ‚ùå Used `gateway.restart` tool ‚Üí Only sends SIGUSR1, doesn't reload env
4. ‚ùå Tried `openclaw gateway restart` ‚Üí Didn't reload LaunchAgent plist

**Root cause discovery:**
- Gateway runs as LaunchAgent (`com.clawdbot.gateway`)
- LaunchAgent plist defines environment at service registration
- SIGUSR1 reloads *config files* but NOT *environment variables*
- Environment must be in plist OR loaded before gateway starts

**Solution:**
1. Added all tokens to LaunchAgent plist `<EnvironmentVariables>` section
2. Ran `launchctl unload/load` to reload plist
3. Gateway restarted with proper environment ‚Üí Telegram working! ‚úÖ

### üìù Lessons Learned

1. **LaunchAgent environment isolation:**
   - Services don't inherit shell environment
   - Must explicitly define vars in plist OR use shell wrapper script
   - SIGUSR1 restart ‚â† full service reload

2. **Secret management strategy:**
   - `~/.env` (chmod 600) for human-readable central storage
   - LaunchAgent plist for service environment
   - `.gitignore` to prevent future leaks
   - Consider vault (Vaultwarden) for production secrets

3. **Testing token changes:**
   - Verify token with direct API call first: `curl https://api.telegram.org/bot<TOKEN>/getMe`
   - Check running process environment: `launchctl print gui/$(id -u)/<service>`
   - Full service restart > signal-based reload for env changes

4. **Git security:**
   - Secrets in commits stay in history even after deletion
   - Redaction in HEAD prevents future exposure
   - History rewrite (BFG/filter-repo) needed for full removal
   - Revoked tokens reduce urgency of history cleanup

### ‚úÖ Final Status

**Security posture:**
- ‚úÖ All tokens rotated or secured
- ‚úÖ No secrets in git (HEAD)
- ‚úÖ Centralized secret management (`~/.env`)
- ‚úÖ LaunchAgent properly configured
- ‚úÖ `.gitignore` prevents future leaks
- ‚úÖ Telegram bidirectional communication working
- ‚úÖ Slack still functioning
- ‚ö†Ô∏è Old token remains in git history (commit a093a0d3) - revoked, low risk

**GitHub alert:** Can be dismissed as "revoked" - token is no longer valid.

### üéâ Verification

**Telegram test:** Sent/received multiple messages successfully
- Messages 109-115: During token rotation (receive-only, couldn't reply)
- Message 125+: Full bidirectional communication restored

**Time to resolution:** ~3.5 hours (mostly troubleshooting LaunchAgent environment)
